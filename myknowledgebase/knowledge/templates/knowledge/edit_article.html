<!-- knowledge/templates/knowledge/edit_article.html -->
{% extends 'knowledge/base.html' %}
{% load widget_tweaks %}
{% load static %}
{% block content %}
  <h2>Edit an Existing Knowledge Base Article</h2>
  <form method="POST" id="kbEntryForm">
    {% csrf_token %}
    {% for field in form %}
        {% if not field.name == "meta_data" %}
            <div class="form-group">
        {% if field.name == "article" %}
            <label for="quillEditor">{{ field.label }}</label>
            <div id="quillEditor" style="height: 200px;">{{ field.value }}</div>
            {{ field|attr:"style:display:none;" }}
        {% else %}
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field|add_class:"form-control" }}
        {% endif %}
        {% endif %}
            </div>
    {% endfor %}

    <div class="form-group">
        <label for="metatagLookup">Lookup/Add Metatag:</label>
        <input type="text" id="metatagLookup" class="form-control" placeholder="Type to search or add a new tag..." />
    </div>
    
    <div class="form-group">
        <label>Selected Meta Data:</label>
        <div id="selectedMetatags"></div>
        <input type="hidden" name="meta_data" id="meta_data_input">
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
  </form>

  {% if form.errors %}
  <div class="alert alert-danger">
    <ul>
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
          <li><strong>{{ field }}:</strong> {{ error|escape }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}
    <style>
        #metatagDropdown {
            border: 1px solid #ccc;
            max-height: 100px;
            overflow-y: auto;
            position: absolute;          
            z-index: 1000; /* to ensure it appears on top */
            background-color: white;
        }
        
        #metatagDropdown div {
            padding: 5px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        #metatagDropdown div:last-child {
            border-bottom: none;
        }
        
        #metatagDropdown div:hover {
            background-color: #f7f7f7;
        }
    </style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
    var ToolbarOptions = [
            ["bold", "italic", "underline", "strike"], // Text formatting options
            [{ list: "ordered" }, { list: "bullet" }], // List options
            [{ size: [false, "large"] }], // Font size
            [{ indent: "-1" }, { indent: "+1" }], // Indentation options
            [{ font: [] }], // Font family
            [{ align: [] }], // Text alignment
            ["link", "image", "video"], // Additional options like link, image, and video
            ["clean"], // Remove formatting option
    ];

    var quill = new Quill('#quillEditor', {
      theme: 'snow',
      modules: {
        toolbar: ToolbarOptions,
      },
    });
    quill.root.innerHTML = "{{ article.article|escapejs }}";
    var article = document.querySelector('textarea[name=article]');
    quill.on('text-change', function() {
      article.value = quill.root.innerHTML;
    });
    // Event listener for metatag lookup field

    const meta_data_input = document.getElementById('meta_data_input');

    const metatags = {{ all_tags_json|safe }};
    
    const selectedMetatags = document.getElementById('selectedMetatags');

    const initialMetatags = "{{ associated_metatags|join:','|default:''|safe }}".split(',');
    initialMetatags.forEach(tag => {
        addMetatagToSelected(tag);
    });

    const metatagLookup = document.getElementById('metatagLookup');

    const metatagDropdown = document.createElement('div');
    metatagDropdown.id = "metatagDropdown"; // set the id for CSS styling
    metatagLookup.parentNode.insertBefore(metatagDropdown, metatagLookup.nextSibling);
    
    const form = document.getElementById('kbEntryForm');
    
    
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        let selectedTags = Array.from(selectedMetatags.children).map(button => button.innerText);
        meta_data_input.value = selectedTags.join(','); // Assuming comma-separated values       
        form.submit();
    });

    
    metatagLookup.addEventListener('keydown', function(event) {
        console.log("Key pressed:", event.key);
        if (event.key === "Enter") {
            event.preventDefault(); // Stop the Enter key from submitting the form
        }
    });

    metatagLookup.addEventListener('keyup', function(event) {
        if (event.key !== "Enter") {
            // Clear the dropdown first
            metatagDropdown.innerHTML = '';
            
            // Filter the metatags based on user input
            let value = metatagLookup.value.trim();
            let matches = metatags.filter(tag => tag.includes(value));
            
            // Populate the dropdown with matching tags
            matches.forEach(match => {
                let tagElement = document.createElement('div');
                tagElement.innerText = match;
                tagElement.onclick = function() {
                    addMetatagToSelected(match);
                    metatagDropdown.innerHTML = '';  // Clear the dropdown
                    metatagLookup.value = '';  // Clear the input
                    updateMetaDataInput();  // Update the hidden input after adding a tag
                };
                metatagDropdown.appendChild(tagElement);
            });
        } else {
            let value = metatagLookup.value.trim();
            if (!metatags.includes(value)) {
                metatags.push(value);  // Add to mock data
                addMetatagToSelected(value);
            }
            metatagDropdown.innerHTML = '';  // Clear the dropdown
            metatagLookup.value = '';  // Clear the input
        }
    });

    function addMetatagToSelected(tag) {
        if (!tag || !tag.trim()) return;  // Check if tag is empty or just spaces
        // Check if the tag is already added
        let existingTags = Array.from(selectedMetatags.children).map(button => button.innerText);
        if (existingTags.includes(tag)) {
            console.log(`Tag "${tag}" is already added.`);
            return;
        }
        console.log("Tags before submission: ", meta_data_input.value);
        console.log("Current number of tags:", selectedMetatags.children.length);
        console.log("Adding tag:", tag);  // Debugging line
    
        let tagButton = document.createElement('button');
        tagButton.type = 'button';
        tagButton.innerText = tag;
        tagButton.className = 'btn btn-secondary m-1';
        tagButton.onclick = function() {
            console.log("Attempting to remove tag:", tagButton.innerText);
            selectedMetatags.removeChild(tagButton);
            updateMetaDataInput();  // Update the hidden input after removing a tag
        };
        selectedMetatags.appendChild(tagButton);
    
        console.log("Updated number of tags:", selectedMetatags.children.length);
        updateMetaDataInput();  // Update the hidden input after adding a tag
    }

    function updateMetaDataInput() {
        let selectedTags = Array.from(selectedMetatags.children).map(button => button.innerText);
        console.log("Selected tags array:", selectedTags);
        meta_data_input.value = selectedTags.join(','); // Assuming comma-separated values
        console.log("Updated hidden input with tags:", meta_data_input.value);
    }
    });
  </script>
{% endblock %}